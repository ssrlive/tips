# Windows tips

## Windows 11 越做越爛

- 啓用 Administrator 賬號後，會自動禁用 UAC，導致所有程序都以高特權級別運行，這樣非常不安全。
- 右鍵菜單默認是新風格，很多常用選項被隱藏在「顯示更多選項」裏，這樣很不方便。
- Snap Assist 分屏容器功能很煩人，經常彈出來擋住視線。
- 輸入法切換快捷鍵是 Win + 空格，這個快捷鍵不如 Ctrl + 空格 方便， 還禁止你改回 Ctrl + 空格。
- 設置界面很亂，很多選項找不到了。 還同時並存老的控制面板，讓人無所適從。
- 在 Administrator 賬號下，登錄 微軟賬號後，會強行接管系統登錄，禁用本地賬號，無法在沒有網絡的情況下登錄系統。
- 在 微軟賬號下，如果你 使用 安全模式 登錄系統，即使你告訴系統要使用網絡，系統也不會啓用網絡，導致你無法登錄 微軟賬號。
  這就直接廢掉了你的系統，只能重裝系統。 這是一個死鎖：要網絡才能登錄 微軟賬號，安全模式下網絡又不可用，而且你也沒法回到正常模式。
- 系統更新經常失敗，有個月度累積更新，連續失敗了好幾個月，最後只能重裝系統。

## 關閉 Windows 11 的 Snap Assist 分屏容器

在 Windows 11 中，當你將窗口拖到屏幕邊緣時，會自動彈出「Snap Assist」分屏容器。要關閉這個功能，請按照以下步驟操作：

1. 打開「設定」（Settings）。
2. 點擊「系統」（System）。
3. 選擇「多工處理」（Multitasking）。
4. 在「窗口停靠」（Snap windows）下，將「當我將窗口拖到螢幕邊緣時顯示可用的停靠佈局」這個選項關閉即可。

這樣就不會再自動彈出分屏容器窗口了。

## 將 Windows 11 桌面右鍵菜單恢復爲 舊有 風格

在 Windows 11 上，右键菜单默认会显示 “Show more options” 来切换到旧版（经典）右键菜单。

但你可以通过以下方式让所有右键菜单都直接显示旧风格：

1. **注册表修改法（全局生效）**  
   打开 cmd （管理员），运行：
   ```
   reg.exe add "HKCU\Software\Classes\CLSID\{86ca1aa0-34aa-4e8b-a509-50c905bae2a2}" /f
   reg.exe add "HKCU\Software\Classes\CLSID\{86ca1aa0-34aa-4e8b-a509-50c905bae2a2}\InprocServer32" /f /ve
   ```
   然后重启资源管理器或电脑。

2. **还原方法**  
   删除上述注册表项即可恢复 Windows 11 新菜单。


## 將 Administrator 賬號的高特權級別降爲普通用戶

重裝 Windows 系統後，從普通賬號 啓用 Administrator 賬號，使用命令
```powershell
net user Administrator /active:yes
```
然後 登錄 Administrator 賬號，現在 可能的 情況是， 運行任何程序 都是 高特權級別， 而且連 `UAC` 提示 都沒有， run 對話框像下面這樣

<img width="413" height="229" alt="Image" src="https://github.com/user-attachments/assets/c23cc447-9800-4659-916a-a97b25bca998" />

這樣很不安全，因爲任何程序都可以隨便改系統設置，安裝惡意軟件。

解決方法是，透過本地安全策略讓 UAC 對 Administrator 生效，具體操作如下：

- 按 Win+R，輸入 `secpol.msc`，回車。
- 展開「本地策略」→「安全選項」。
- 找到「用戶帳戶控制：用戶提升時的管理員批准模式」。
- 將「Administrator 帳戶的管理員批准模式」設為「啟用」。
- 登出 Administrator 帳號，重新登入。

這樣，Administrator 帳號也會受到 UAC 控制，啟動程式時會彈出 UAC 確認對話框。

<img width="969" height="523" alt="Image" src="https://github.com/user-attachments/assets/789a86a8-3186-4b7f-abd2-9c118df7329d" />


## 使用 `Ctrl + 空格` 替換 `Win + 空格` 切換輸入法

在 `Windows 10` 和以後的版本中，`Win + 空格` 快捷鍵被用來切換輸入法，這個快捷鍵在 `Windows 7` 中是 `Ctrl + 空格`。

個人覺得 `Ctrl + 空格` 更方便，而且可以與 `Linux` 和 `Mac` 保持一致。

以下是操作過程：

- 下載 [AutoHotkey](https://github.com/AutoHotkey/AutoHotkey/releases)，解壓到 `c:\AutoHotkey` 文件夾。
- 運行 `C:\AutoHotkey\AutoHotkey64.exe`, 這時會提示錯誤說找不到 `AutoHotkey64.ahk` 文件。
- 創建 `C:\AutoHotkey\AutoHotkey64.ahk` 文本文件，並用記事本打開，輸入以下內容：
  ```ahk
  ^Space::#Space
  ```
  這裏 `^` 表示 `Ctrl` 鍵，`#` 表示 `Win` 鍵，`Space` 表示 `空格` 鍵， `::` 表示替換。
- 保存文件，關閉記事本，再次運行 `C:\AutoHotkey\AutoHotkey64.exe`，這時會在系統托盤中出現一個綠色的 `H` 圖標。
- 現在按下 `Ctrl + 空格` 就可以看到輸入法切換了。

讓這個程序開機自動運行，可以將 `AutoHotkey64.exe` 快捷方式放到自啓動文件夾中。
- 用 `Win + R` 打開 `運行` 窗口，輸入 `shell:startup` 並回車，打開自啓動文件夾。
- 右鍵菜單中選擇 `新建` -> `快捷方式`，創建指向 `C:\AutoHotkey\AutoHotkey64.exe` 的快捷方式。


## 刪除永久路由
在使用虛擬網卡程序以後，使用 `route print -4` 查看路由表, 可能會看到如下內容
```
C:>route print -4
...
============================================================
Persistent Routes:
  Network Address          Netmask  Gateway Address  Metric
          0.0.0.0          0.0.0.0         10.0.0.1       1
============================================================
```
這條永久路由可能爲你的工作帶來困擾——只要你在運行這個帶虛擬網卡的程序，
它就粗暴接管了你的真實網卡，讓你上不了網——可以使用以下命令刪掉
```powershell
route -p delete 0.0.0.0 mask 0.0.0.0 10.0.0.1
```
這是 `ChatGPT` 告知的方法。刪掉它後，等一會兒，再用 `route print -4` 查看路由表，
就會發現出口路由已經自動恢復成本機真實網卡的網關了。嗯，完美。

## 查看網卡的 索引號 Index
```
netsh interface ipv4 show interfaces
```
或者
```
route print -4
```
或者使用 `powershell` 命令
```powershell
Get-WMIObject Win32_networkadapter | Select-Object Name, AdapterType, InterfaceIndex | Format-List
```

## 解決突然不能上網的問題

- 用命令 `route print -4` 查看路由表, 
  看看 `0.0.0.0 0.0.0.0 出口網卡的網關IP 出口網卡IP 55` 這一條在不在,
  如果不在, 用命令加上.
  ```
  route add 0.0.0.0 mask 0.0.0.0 出口網卡的網關IP metric 55
  ```
  如果存在, 用命令修改躍點數 metric, 把它改小一點, 比如 40, 這樣能保證這條路由優先使用.
  ```
  route change 0.0.0.0 MASK 0.0.0.0 出口網卡的網關IP METRIC 40
  ```
- 如果上面的方法不行, 用命令 `ipconfig /flushdns` 清除 DNS 緩存, 再用命令 `ipconfig /renew` 更新 IP 地址.
- 如果上面的方法不行, 用命令 `netsh winsock reset` 重置 winsock, 然後重啓電腦.

## TAP-Windows 下載地址

- https://build.openvpn.net/downloads/releases/tap-windows-9.24.2-I601-Win10.exe
- https://build.openvpn.net/downloads/releases/tap-windows-9.24.2-I601-Win7.exe

如果有可用的新版本, 可以在 https://build.openvpn.net/downloads/releases/ 查找.

## Networking

- 查看 Windows 11 裏的 網絡接口, 在 `run` 運行窗口輸入命令 `ncpa.cpl`, 就能打開網絡接口列表窗口.
  ![image](https://user-images.githubusercontent.com/30760636/263430692-21a94aed-c465-4300-b83f-c494fa8f6e8b.png)

- 另外也可以在 `cmd` 命令行下輸入 `ipconfig` 命令, 也可以以文字形式輸出網絡接口列表信息.
  ![image](https://user-images.githubusercontent.com/30760636/263430950-969211a9-cd26-46c5-93fd-e4c2c56212fc.png)

## 使用 Cloudflared 本地 DNS 解析工具让系统全局加密 DNS

`Cloudflare Tunnel client` 这个项目是用于 `DNS over HTTPS` 的客户端,
能够全局接管系统的 `DNS`, 包括 `nslookup`，`ping` 等 (`Win10` 无法实现全局加密 `DNS`)

到 [cloudflared](https://github.com/cloudflare/cloudflared/releases)
下載文件 `cloudflared-windows-amd64.exe` 到 文件夾 `c:\doh`, 並執行它一次, 這時會自動生成 `config.yml` 文件.

用記事本打開 `config.yml` 文件, 以如下内容替換原内容, 並保存關閉文件.
```yml
proxy-dns: true
proxy-dns-port: 53
proxy-dns-address: "::"
proxy-dns-upstream:  
  - https://dns.ipv6dns.com/dns-query  
  - https://223.5.5.5/dns-query
```

用 `管理員權限` 打開 `powershell`, 輸入 `New-Service` 命令創建服务
- 輸入名称： `doh`
- 輸入命令行和參數: `C:\doh\cloudflared-windows-amd64.exe --config C:\doh\config.yml`

![image](https://github.com/cloudflare/cloudflared/assets/30760636/633176ba-4d1c-475e-86fb-683466e3f569)

启动服务
- 在開始菜單裏輸入 `services`, 打開 `服務` 管理器, 啓動 `doh` 服務.

![image](https://github.com/cloudflare/cloudflared/assets/30760636/7ceff53c-1ac0-4705-8358-bbcf6af77196)

修改 系統 DNS
- 将系统當前正工作的互聯網連接的 `DNS` 改为 `127.0.0.1` (`ipv4`) 和 `::1`(`ipv6`)

![image](https://github.com/cloudflare/cloudflared/assets/30760636/4a3d2d0c-0e6c-420d-b541-172d3b8a693f)

操作完畢.
```bat
sc create doh start= auto binPath= "C:\doh\cloudflared-windows-amd64.exe --config C:\doh\config.yml"
net start doh

sc queryex doh

net stop doh
sc delete doh
```


## 乾净徹底清除 PowerShell 历史记录

獲得歷史文件的路徑的方法
```powershell
(Get-PSReadlineOption).HistorySavePath
```
刪除歷史文件的方法
```powershell
Remove-Item (Get-PSReadlineOption).HistorySavePath
```


## 截圖方法

- 使用键盘快捷键：按下 `Alt + Print Screen` 键（通常位于键盘的顶部），这将会截取当前活动窗口的截图，并将其保存到剪贴板中。

- 使用 `Windows键 + Shift + S`：按下 `Windows键`、`Shift键` 和 `S键` 的组合，屏幕会变暗，并显示一个截图工具栏。你可以选择截取整个屏幕、矩形区域或自定义形状的区域。选择所需的截图区域后，截图将保存到剪贴板中，并可以在屏幕截图工具栏上进行编辑和保存。

- 使用 `Snip & Sketch` 工具：在 Windows 11中，你也可以使用 `Snip & Sketch` 工具来截取窗口截图。你可以按下 `Windows键`，然后输入 `Snip & Sketch` 来搜索并打开该工具。在 `Snip & Sketch` 工具中，你可以选择截取整个屏幕、矩形区域、自定义形状的区域或活动窗口。截图将在工具中打开，你可以进行编辑和保存。
